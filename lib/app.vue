<template>
  <div class="top-nav">
    <div class="container">
      <div class="site-nav clearfix">
        <a class="site-logo" href="/">
          <logo></logo>
        </a>
        <nav>
          <a href="{{url}}" v-repeat="$site.links" v-text="name"></a>
        </nav>
      </div>

      <div class="site-account">
        <div class="nav" v-if="!currentUser.username">
          <button v-on="click: showLogin=true">Log in</button>
        </div>
        <ul class="nav clearfix" v-if="currentUser.username">
          <li>
            <a v-if="notificationCount" class="tip notification" href="javascript:;"
            v-on="click: showNotifications=true"
            aria-label="You have {{ notificationCount }} unread notifications"></a>
            <overlay v-if="showNotifications" show="{{@ showNotifications }}">
              <user-notifications></user-notifications>
            </overlay>
          </li>
          <li>
            <user-avatar user="{{currentUser}}" v-on="click: showUserDropdown=true | preventDefault"></user-avatar>
            <dropdown v-show="showUserDropdown" show="{{@ showUserDropdown }}">
              <a class="dropdown-item" href="/u/{{ currentUser.username }}">View Profile</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="/account/settings">Settings</a>
              <a class="dropdown-item" v-on="click: logout|preventDefault" href="/session">Logout</a>
            </dropdown>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <component is="{{view}}"
  params="{{params}}"
  v-transition
  transition-mode="out-in">
</component>

<div class="footer">
  <div class="container">
    <div style="float: left">Copyright &copy; {{year}} {{$site.name}}</div>
    <div style="float: right">
      <a href="https://github.com/lepture/zerqu">ZERQU</a> •
      <a href="https://github.com/zerqu/qingcheng">青城</a>
    </div>
  </div>
</div>

<div id="message" aria-live="assertive">
  <div class="message message-{{type}}" v-repeat="messages" v-text="text" v-transition="fade"></div>
</div>
<overlay v-if="showLogin" v-transition="fade" show="{{@ showLogin }}">
  <login-form></login-form>
</overlay>
</template>

<script>
  var api = require('./api');
  module.exports = {
    el: '#app',
    data: {
      view: '',
      currentUser: {},
      notificationCount: 0,
      showLogin: false,
      showNotifications: false,
      showUserDropdown: false,
      year: new Date().getFullYear(),
      messages: [],
      params: {}
    },
    methods: {
      logout: function() {
        api.user.logout();
      },
      check: function() {
        if (!this.currentUser.id) return;
        api.notification.count(function(resp) {
          this.notificationCount = resp.count;
        }.bind(this));
      }
    },
    ready: function() {
      setTimeout(this.check.bind(this), 2000);
      // check every 5 minutes
      setInterval(this.check.bind(this), 300000);
    },
    components: {
      'home': require('./home.vue'),
      'cafe': require('./cafe.vue'),
      'topic': require('./topic.vue'),
      'user': require('./user.vue'),
      'cafe-list': require('./cafe-list.vue'),
      'user-list': require('./user-list.vue'),
      'overlay': require('./components/overlay.vue'),
      'dropdown': require('./components/dropdown.vue'),
      'logo': require('./components/logo.vue'),
      'user-avatar': require('./components/user-avatar.vue'),
      'login-form': require('./components/login-form.vue'),
      'user-notifications': require('./components/user-notifications.vue'),
    }
  }
</script>
